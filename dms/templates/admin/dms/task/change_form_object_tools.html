{% extends 'admin/change_form_object_tools.html' %}
{% load static %}

{% block object-tools-items %}
    <li>
        <a id="id_download_table_mappings" href="{% url 'dms:download_table_mapping' object_id %}" onclick="return false;">下载表映射</a>
    </li>
    {{ block.super }}
    <script>
        function downloadFile(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        // 在数字前补零
        function padZero(num) {
            return (num < 10 ? "0" : "") + num;
        }

        function now() {
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const day = currentDate.getDate();
            const hours = currentDate.getHours();
            const minutes = currentDate.getMinutes();
            const seconds = currentDate.getSeconds();

            // 格式化为没有分隔符的字符串
            return padZero(year) + '_' + padZero(month) + '_' + padZero(day)
                + 'T' + padZero(hours) + '_' + padZero(minutes) + '_' + padZero(seconds);
        }

        django.jQuery('#id_download_table_mappings').click(function () {
            django.jQuery.get(django.jQuery(this).prop('href'), {}, function (data, status) {
                const filename = data.name + `-${now()}.json`;
                downloadFile(filename, JSON.parse(data.table_mappings));
            })
        });
    </script>
{% endblock %}
